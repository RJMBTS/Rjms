name: King üëë

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

concurrency:
  group: king-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge Live + Radio (Pawn) + VOD (Bishop)
        run: |
          set -e

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")

          # ==========================
          # PLAYLIST HEADER (BRANDING)
          # ==========================
          {
            echo '#EXTM3U playlist-name="RJM OTT - An RJMBTS Network" billed-msg="RJM OTT - An RJMBTS Network"'
            echo "# Coded & Maintained @RJMBTS"
            echo "# Last updated: $timestamp"
          } > King.m3u

          echo "" >> King.m3u

          # ==========================
          # LIVE TV
          # ==========================
          echo "# ===== LIVE TV =====" >> King.m3u
          curl -fsSL --retry 3 --retry-delay 5 \
            "https://raw.githubusercontent.com/RJMBTS/Rjms/refs/heads/main/master.m3u" \
            | sed '1{/^#EXTM3U/d}' >> King.m3u

          echo "" >> King.m3u

          # ==========================
          # RADIO (PAWN.M3U)
          # CONTENT UNTOUCHED
          # ==========================
          echo "# ===== RADIO =====" >> King.m3u
          curl -fsSL --retry 3 --retry-delay 5 \
            "https://rjmbts.github.io/Rjms/Pawn.m3u" \
            | sed '1{/^#EXTM3U/d}' >> King.m3u

          echo "" >> King.m3u

          # ==========================
          # MEDIA LIBRARY (VOD) - BISHOP
          # ==========================
          echo "# ===== MEDIA LIBRARY (VOD) =====" >> King.m3u
          curl -fsSL --retry 3 --retry-delay 5 \
            "https://rjmbts.github.io/Rjms/Bishop/Amzp.m3u" \
            | sed '1{/^#EXTM3U/d}' \
            | awk '
              /^#EXTINF/ {
                if ($0 !~ /tvg-type="vod"/) {
                  sub(/^#EXTINF:/, "#EXTINF:-1 tvg-type=\"vod\" ", $0)
                }
              }
              { print }
            ' >> King.m3u

          echo "‚úÖ Merge completed (Live + Radio + VOD)"

          # ==========================
          # SAFETY CHECK
          # ==========================
          if ! grep -q "#EXTINF" King.m3u; then
            echo "‚ùå King.m3u has no streams. Aborting."
            exit 1
          fi

      - name: Commit and push King.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add King.m3u

          if ! git diff --cached --quiet; then
            git commit -m "Build King.m3u (Live + Radio + VOD)"
            git pull --rebase origin main || true
            git push origin main
          else
            echo "No changes detected"
          fi
