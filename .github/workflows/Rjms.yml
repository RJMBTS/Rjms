name: RJMS âš“

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

concurrency:
  group: rjms-generator
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Generate master.m3u (clean, sorted)
        run: |
          set -e

          SRC_URL="https://rjmbts.github.io/Rjms/Rook.m3u"
          OUTPUT="master.m3u"
          TMP_RAW=$(mktemp)
          TMP_BODY=$(mktemp)

          echo "â¬‡ï¸ Fetching source..."
          curl -fsSL "$SRC_URL" -o "$TMP_RAW"

          COUNT=$(grep -c '^#EXTINF' "$TMP_RAW" || true)
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")

          # ðŸ”¹ Write SINGLE clean header (your exact format)
          {
            echo '#EXTM3U billed-msg="RJM Tv - An RJMBTS Network"'
            echo "# Pushed & Updated by Kittujk"
            echo "# Scripted & Maintained by @RJMBTS"
            echo "# Last updated on : $timestamp"
            echo "# Channels : Total - $COUNT | Updated - $COUNT"
            echo ""
          } > "$OUTPUT"

          # ðŸ”¹ Selective cleanup of upstream headers
          grep -Ev '^(#EXTM3U|#Generated on |# Pushed|# Scripted|# Channels|# Last updated|# Coded)' \
            "$TMP_RAW" > "$TMP_BODY"

          echo "ðŸ“¦ Sorting groups (original titles preserved)..."

          # ðŸ”¹ Priority group order
          for grp in \
            "Devotional" \
            "ETv Win" \
            "SunNxt" \
            "Star" \
            "Z5" \
            "Sliv" \
            "Kids" \
            "Movies" \
            "Music" \
            "Entertainment" \
            "Local Telugu" \
            "Local Tamil" \
            "Local Malayalam" \
            "News" \
            "Infotainment" \
            "Business News" \
            "Sports" \
            "Educational"
          do
            awk -v G="$grp" '
              BEGIN { IGNORECASE=1 }
              /^#EXTINF/ {
                if ($0 ~ "group-title=\".*" G ".*\"") {
                  print
                  getline
                  print
                }
              }
            ' "$TMP_BODY" >> "$OUTPUT"
          done

          # ðŸ”¹ Remaining / unmatched groups (kept as-is)
          awk '
            BEGIN { IGNORECASE=1 }
            /^#EXTINF/ {
              if ($0 !~ /group-title=".*(Devotional|ETv Win|SunNxt|Star|Z5|Sliv|Kids|Movies|Music|Entertainment|Local Telugu|Local Tamil|Local Malayalam|News|Infotainment|Business News|Sports|Educational).*"/) {
                print
                getline
                print
              }
            }
          ' "$TMP_BODY" >> "$OUTPUT"

          echo "âœ… master.m3u generated successfully"

      - name: Commit & Push
        run: |
          git config user.name "playlist-bot"
          git config user.email "bot@github.com"

          git add master.m3u
          git diff --cached --quiet && echo "No changes to commit" && exit 0

          git commit -m "Auto update master.m3u (clean & sorted)"
          git push
