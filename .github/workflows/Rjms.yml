name: RJMS âš“

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

concurrency:
  group: rjms-generator
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Generate master.m3u from Rook
        run: |
          set -e

          SRC_URL="https://rjmbts.github.io/Rjms/Rook.m3u"
          OUTPUT="master.m3u"
          tmp=$(mktemp)

          echo "â¬‡ï¸ Fetching Rook.m3u..."
          curl -fsSL "$SRC_URL" -o "$tmp"

          COUNT=$(grep -c '^#EXTINF' "$tmp" || true)
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")

          echo "ðŸ§± Writing header..."
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo "# Generated by RJMS Generator"
            echo "# Last updated : $timestamp"
            echo "# Channels : $COUNT"
            echo ""
          } > "$OUTPUT"

          echo "ðŸ§¹ Cleaning source & appending..."
          grep -Ev '^(#EXTM3U|#Generated on )' "$tmp" >> "$OUTPUT"

          echo "âœ… master.m3u generated"

      - name: Commit & Push Playlist
        run: |
          git config user.name "playlist-bot"
          git config user.email "bot@github.com"

          git add master.m3u
          git diff --cached --quiet && echo "No changes to commit" && exit 0

          git commit -m "Auto update master.m3u (from Rook)"
          git push
