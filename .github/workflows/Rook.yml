name: Rook â™Ÿ

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

concurrency:
  group: rook-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Rook.m3u from selected Bishop sources
        run: |
          set -e

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          echo "ðŸ”¹ Building Rook.m3u at $timestamp"

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # WRITE SINGLE ROOK HEADER (overwrite mode)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo '# Pushed and Updated by Kittujk'
            echo '# Scripted & Maintained by @RJMBTS'
            echo '# Channels : Total - 0 | Updated - 0'
            echo "# Last updated: $timestamp"
            echo ""
          } > Rook.m3u

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # SOURCE LIST
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          cat <<EOF > "$tmpdir/sources.txt"
          Bishop/P1js.m3u
          Bishop/P1s.m3u
          Bishop/P1z.m3u
          Bishop/Stnl.m3u
          Bishop/Stgl.m3u
          Bishop/Smly.m3u
          EOF

          i=0
          while read -r file; do
            [ ! -f "$file" ] && echo "âš ï¸ Missing: $file" && continue

            i=$((i+1))
            printf -v idx "%03d" "$i"

            echo "âœ… Adding $file"

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # STRIP ALL SOURCE HEADERS COMPLETELY
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            grep -vi -E \
            '^#EXTM3U|\
            ^#\s*(pushed|coded|scripted).*maintained|\
            ^#\s*last\s*updated|\
            ^#\s*channels\s*:|\
            join\s*telegram' \
            "$file" > "$tmpdir/part_$idx.m3u" || true

          done < "$tmpdir/sources.txt"

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # COMBINE CLEAN PARTS
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          for part in "$tmpdir"/part_*.m3u; do
            [ -s "$part" ] || continue
            cat "$part" >> Rook.m3u
            echo "" >> Rook.m3u
          done

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # COUNT CHANNELS
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          total_channels=$(grep -c '^#EXTINF' Rook.m3u || true)

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # UPDATE HEADER COUNT
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          sed -i "s/# Channels : Total - 0 | Updated - 0/# Channels : Total - $total_channels | Updated - $total_channels/" Rook.m3u

          echo "âœ… Rook.m3u built with $total_channels channels."

      - name: Commit and push Rook.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add Rook.m3u

          if ! git diff --cached --quiet; then
            git pull --rebase origin main || true
            git commit -m "Auto-update Rook.m3u"
            git push origin main
          else
            echo "No changes detected â€” skipping commit."
          fi

      - name: Summary
        run: |
          echo "âœ… Rook â™Ÿ updated successfully"
